const STATE = require('STATE')
const statedb = STATE(__filename)
const { sdb, get } = statedb(fallback_module)

module.exports = focus_tracker

async function focus_tracker (opts, protocol) {
  const { id, sdb } = await get(opts.sid)
  const { drive } = sdb

  // Keep track of the last focused element
  let last_focused = null

  if (protocol) {
    protocol(msg => {
      const { type, data } = msg
      if (type === 'ui_focus') {
        last_focused = data
        console.log('Focus Tracker: Last focused element:', last_focused)
      }
    })
  }

  const el = document.createElement('div')
  const shadow = el.attachShadow({ mode: 'closed' })

  // Hidden component
  el.style.display = 'none'
  shadow.innerHTML = `
  <div class="focus-tracker"></div>
  `

  await sdb.watch(onbatch)

  return el

  async function onbatch (batch) {
    // @TODO
  }
}

function fallback_module () {
  return {
    api: fallback_instance
  }
  function fallback_instance () {
    return {
      drive: {}
    }
  }
}
