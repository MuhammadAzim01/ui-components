const STATE = require('STATE')
const statedb = STATE(__filename)
const { get } = statedb(fallback_module)

module.exports = control_unit

async function control_unit (opts, protocol) {
  const { id, sdb } = await get(opts.sid)
  const { drive } = sdb
  const ids = opts.ids
  if (!ids || !ids.up) {
    throw new Error(`Component ${__filename} requires ids.up to be provided`)
  }
  const by = id
  const to = ids.up
  
  let send = null
  let _ = null
  let mid = 0
  
  if (protocol) {
    send = protocol(msg => onmessage(msg))
    _ = { up: send }
  }

  await sdb.watch(() => {})

  async function onmessage (msg) {
    const { type, data } = msg
    
    if (type === 'focused_app_changed') {
      if (_.up) {
        const focused_app = data?.focused_app
        let actions_data = null
        
        if (focused_app) {
          const file = `temp_actions/${focused_app}.json`
          const temp_actions_file = await drive.get(file)
          if (temp_actions_file) {
            actions_data = typeof temp_actions_file.raw === 'string' ? JSON.parse(temp_actions_file.raw) : temp_actions_file.raw
          }
        }
        
        const message_data = {
          ...data,
          temp_actions: actions_data
        }
        const head = [by, to, mid++]
        const refs = msg.head ? { cause: msg.head } : {}
        _.up({ head, refs, type: 'update_actions_for_app', data: message_data })
      }
    }
  }
}

function fallback_module () {
  return {
    api: fallback_instance,
    drive: {}
  }
  function fallback_instance () {
    return {
      drive: {
        'temp_actions/': {
          'command_history.json': {
            raw: JSON.stringify([
              {
                action: 'Clear History',
                pinned: false,
                default: true,
                icon: 'trash'
              },
              {
                action: 'Export History',
                pinned: true,
                default: false,
                icon: 'download'
              },
              {
                action: 'Search History',
                pinned: false,
                default: true,
                icon: 'search'
              }
            ])
          },
          'task_manager.json': {
            raw: JSON.stringify([
              {
                action: 'Kill Process',
                pinned: false,
                default: true,
                icon: 'stop'
              },
              {
                action: 'Restart Task',
                pinned: true,
                default: false,
                icon: 'refresh'
              },
              {
                action: 'Task Details',
                pinned: false,
                default: true,
                icon: 'info'
              }
            ])
          },
          'tab.json': {
            raw: JSON.stringify([
              {
                action: 'New Tab',
                pinned: true,
                default: true,
                icon: 'plus'
              },
              {
                action: 'Duplicate Tab',
                pinned: false,
                default: false,
                icon: 'copy'
              },
              {
                action: 'Close Tab',
                pinned: false,
                default: true,
                icon: 'close'
              }
            ])
          },
          'wizard_hat.json': {
            raw: JSON.stringify([
              {
                action: 'New File',
                pinned: true,
                default: true,
                icon: 'file'
              },
              {
                action: 'Open File',
                pinned: false,
                default: true,
                icon: 'folder'
              },
              {
                action: 'Save File',
                pinned: true,
                default: false,
                icon: 'save'
              },
              {
                action: 'Settings',
                pinned: false,
                default: true,
                icon: 'gear'
              },
              {
                action: 'Help',
                pinned: false,
                default: false,
                icon: 'help'
              },
              {
                action: 'Terminal',
                pinned: true,
                default: true,
                icon: 'terminal'
              },
              {
                action: 'Search',
                pinned: false,
                default: true,
                icon: 'search'
              }
            ])
          }
        }
      }
    }
  }
}
