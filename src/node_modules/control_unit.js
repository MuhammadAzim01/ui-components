const STATE = require('STATE')
const statedb = STATE(__filename)
const { get } = statedb(fallback_module)

module.exports = control_unit

async function control_unit (opts, protocol) {
  const { id, sdb } = await get(opts.sid)
  const ids = opts.ids
  if (!ids || !ids.up) {
    throw new Error(`Component ${__filename} requires ids.up to be provided`)
  }
  const by = id
  const to = ids.up
  
  let send = null
  let _ = null
  let mid = 0
  
  if (protocol) {
    send = protocol(msg => onmessage(msg))
    _ = { up: send }
  }

  await sdb.watch(() => {})

  function onmessage (msg) {
    const { type, data } = msg
    
    if (type === 'focused_app_changed') {
      if (_.up) {
        const head = [by, to, mid++]
        const refs = msg.head ? { cause: msg.head } : {}
        _.up({ head, refs, type: 'update_actions_for_app', data: data })
      }
    }
  }
}

function fallback_module () {
  return {
    api: fallback_instance,
    drive: {}
  }
  function fallback_instance () {
    return {
      drive: {}
    }
  }
}

