const STATE = require('STATE')
const statedb = STATE(__filename)
const { get } = statedb(fallback_module)

const space = require('space')
const taskbar = require('taskbar')
const focus_tracker = require('focus_tracker')

module.exports = theme_widget

async function theme_widget (opts, protocol) {
  const { id, sdb } = await get(opts.sid)
  const { drive } = sdb

  const on = {
    style: inject
  }

  const el = document.createElement('div')
  const shadow = el.attachShadow({ mode: 'closed' })
  shadow.innerHTML = `
  <div class="theme-widget main">
    <div class="space-slot"></div>
    <div class="taskbar-slot"></div>
  </div>
  <style>
  </style>
  `

  const style = shadow.querySelector('style')
  const space_slot = shadow.querySelector('.space-slot')
  const taskbar_slot = shadow.querySelector('.taskbar-slot')

  const subs = await sdb.watch(onbatch)

  let space_el = null
  let taskbar_el = null
  const _ = { send_space: null, send_taskbar: null, send_focus_tracker: null }
  if (protocol) {
    _.up = protocol(onmessage_from_root)
  }
  
  function onmessage_from_root (msg) {
    const action_handlers = {
      update_actions_for_app: root__update_actions_for_app,
      update_quick_actions_for_app: root__forward_taskbar,
      update_steps_wizard_for_app: root__forward_taskbar
    }
    const handler = action_handlers[msg.type] || root__noop
    handler(msg)

    function root__update_actions_for_app (msg) {
      if (_.send_space) _.send_space(msg)
      else setTimeout(root__retry_send_space, 500, msg)
    }

    function root__retry_send_space (msg) {
      _.send_space && _.send_space(msg)
    }

    function root__forward_taskbar (msg) {
      _.send_taskbar && _.send_taskbar(msg)
    }

    function root__noop () {}
  }
  await focus_tracker({ ...subs[2], ids: { up: id } }, focus_tracker_protocol)
  taskbar_el = await taskbar({ ...subs[1], ids: { up: id } }, taskbar_protocol)
  taskbar_slot.replaceWith(taskbar_el)
  
  space_el = await space({ ...subs[0], ids: { up: id } }, space_protocol)
  space_el.classList.add('space')
  space_slot.replaceWith(space_el)

  return el

  async function onbatch (batch) {
    for (const { type, paths } of batch) {
      const data = await Promise.all(paths.map(path => drive.get(path).then(file => file.raw)))
      // console.log(data, type)
      const func = on[type] || fail
      func(data, type)
    }
  }
  function fail (data, type) { console.warn('invalid message', { cause: { data, type } }) }
  function inject (data) {
    style.replaceChildren((() => {
      const style_el = document.createElement('style')
      style_el.textContent = data[0]
      return style_el
    })())
  }

  // ---------
  // PROTOCOLS
  // ---------
  function space_protocol (send) {
    _.send_space = send
    const action_handlers = {
      ui_focus: space__forward_focus_tracker,
      set_doc_display_handler: space__forward_up
    }
    return on
    function on (msg) {
      const handler = action_handlers[msg.type] || space__forward_taskbar
      handler(msg)
    }

    function space__forward_focus_tracker (msg) {
      _.send_focus_tracker && _.send_focus_tracker(msg)
    }

    function space__forward_up (msg) {
      _.up && _.up(msg)
    }

    function space__forward_taskbar (msg) {
      _.send_taskbar && _.send_taskbar(msg)
    }
  }

  function taskbar_protocol (send) {
    _.send_taskbar = send
    const action_handlers = {
      ui_focus: taskbar__forward_focus_tracker,
      docs_toggle: taskbar__docs_toggle,
      set_docs_mode: taskbar__forward_up
    }
    return on
    function on (msg) {
      const handler = action_handlers[msg.type] || taskbar__forward_space
      handler(msg)
    }

    function taskbar__forward_focus_tracker (msg) {
      _.send_focus_tracker && _.send_focus_tracker(msg)
    }

    function taskbar__docs_toggle (msg) {
      _.send_focus_tracker && _.send_focus_tracker(msg)
      _.send_space && _.send_space(msg)
    }

    function taskbar__forward_up (msg) {
      _.up && _.up(msg)
    }

    function taskbar__forward_space (msg) {
      _.send_space && _.send_space(msg)
    }
  }

  function focus_tracker_protocol (send) {
    _.send_focus_tracker = send
    const action_handlers = {
      focused_app_changed: focus_tracker__forward_up
    }
    return on
    function on (msg) {
      const handler = action_handlers[msg.type] || focus_tracker__noop
      handler(msg)
    }

    function focus_tracker__forward_up (msg) {
      _.up && _.up(msg)
    }

    function focus_tracker__noop () {}
  }
}

function fallback_module () {
  return {
    api: fallback_instance,
    _: {
      space: {
        $: ''
      },
      taskbar: {
        $: ''
      },
      focus_tracker: {
        $: ''
      }
    },
    drive: {}
  }

  function fallback_instance () {
    return {
      _: {
        space: {
          0: '',
          mapping: {
            style: 'style',
            icons: 'icons',
            commands: 'commands',
            scroll: 'scroll',
            actions: 'actions',
            hardcons: 'hardcons',
            files: 'files',
            highlight: 'highlight',
            active_tab: 'active_tab',
            entries: 'entries',
            runtime: 'runtime',
            mode: 'mode',
            flags: 'flags',
            keybinds: 'keybinds',
            undo: 'undo',
            focused: 'focused',
            temp_actions: 'temp_actions',
            temp_quick_actions: 'temp_quick_actions',
            prefs: 'prefs',
            variables: 'variables',
            data: 'data',
            docs: 'docs',
            docs_style: 'docs_style'
          }
        },
        taskbar: {
          0: '',
          mapping: {
            style: 'style',
            icons: 'icons',
            actions: 'actions',
            prefs: 'prefs',
            variables: 'variables',
            data: 'data',
            hardcons: 'hardcons',
            docs: 'docs'
          }
        },
        focus_tracker: {
          0: '',
          mapping: {
            focused: 'focused',
            docs: 'docs'
          }
        }
      },
      drive: {
        'style/': {
          'theme.css': {
            raw: `
              .theme-widget {
                display: flex;
                flex-direction: column;
                width: 100%;
                height: 100%;
                background: #131315;
              }
              .space{
                height: inherit;
              }
            `
          }
        },
        'flags/': {},
        'commands/': {},
        'icons/': {},
        'scroll/': {},
        'actions/': {},
        'hardcons/': {},
        'files/': {},
        'highlight/': {},
        'active_tab/': {},
        'entries/': {},
        'runtime/': {},
        'mode/': {},
        'keybinds/': {},
        'undo/': {},
        'focused/': {},
        'temp_actions/': {},
        'temp_quick_actions/': {},
        'prefs/': {},
        'variables/': {},
        'data/': {},
        'docs_style/': {},
        'docs/': {
          'README.md': {
            $ref: 'README.md'
          }
        }
      }
    }
  }
}
