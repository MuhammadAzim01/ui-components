const STATE = require('STATE')
const statedb = STATE(__filename)
const { get } = statedb(fallback_module)

const space = require('space')
const taskbar = require('taskbar')
const focus_tracker = require('focus_tracker')

module.exports = theme_widget

async function theme_widget (opts) {
  const { id, sdb } = await get(opts.sid)
  const { drive } = sdb

  const on = {
    style: inject
  }

  const el = document.createElement('div')
  const shadow = el.attachShadow({ mode: 'closed' })
  shadow.innerHTML = `
  <div class="theme-widget main">
    <div class="space-slot"></div>
    <div class="taskbar-slot"></div>
  </div>
  <style>
  </style>
  `

  const style = shadow.querySelector('style')
  const space_slot = shadow.querySelector('.space-slot')
  const taskbar_slot = shadow.querySelector('.taskbar-slot')

  const subs = await sdb.watch(onbatch)

  let space_el = null
  let taskbar_el = null
  const _ = { send_space: null, send_taskbar: null, send_focus_tracker: null }

  taskbar_el = await taskbar({ ...subs[1], ids: { up: id } }, taskbar_protocol)
  taskbar_slot.replaceWith(taskbar_el)

  space_el = await space({ ...subs[0], ids: { up: id } }, space_protocol)
  space_el.classList.add('space')
  space_slot.replaceWith(space_el)
  
  await focus_tracker({ ...subs[2], ids: { up: id } }, focus_tracker_protocol)

  return el

  async function onbatch (batch) {
    for (const { type, paths } of batch) {
      const data = await Promise.all(paths.map(path => drive.get(path).then(file => file.raw)))
      // console.log(data, type)
      const func = on[type] || fail
      func(data, type)
    }
  }
  function fail (data, type) { console.warn('invalid message', { cause: { data, type } }) }
  function inject (data) {
    style.replaceChildren((() => {
      const style_el = document.createElement('style')
      style_el.textContent = data[0]
      return style_el
    })())
  }

  // ---------
  // PROTOCOLS
  // ---------
  function space_protocol (send) {
    _.send_space = send
    return on
    function on (msg) {
      if (msg.type === 'ui_focus') _.send_focus_tracker(msg)
      else _.send_taskbar(msg)
    }
  }

  function taskbar_protocol (send) {
    _.send_taskbar = send
    return on
    function on (msg) {
      if (msg.type === 'ui_focus') _.send_focus_tracker(msg)
      else _.send_space(msg)
    }
  }

  function focus_tracker_protocol (send) {
    _.send_focus_tracker = send
    return on
    function on (msg) {
      // @TODO: Focus tracker might send messages back
    }
  }
}

function fallback_module () {
  return {
    api: fallback_instance,
    _: {
      space: {
        $: ''
      },
      taskbar: {
        $: '',
        mapping: {
          style: 'style'
        }
      },
      focus_tracker: {
        $: ''
      }
    }
  }

  function fallback_instance () {
    return {
      _: {
        space: {
          0: '',
          mapping: {
            style: 'style',
            flags: 'flags',
            commands: 'commands',
            icons: 'icons',
            scroll: 'scroll',
            actions: 'actions',
            hardcons: 'hardcons',
            files: 'files',
            highlight: 'highlight',
            active_tab: 'active_tab',
            entries: 'entries',
            runtime: 'runtime',
            mode: 'mode',
            keybinds: 'keybinds',
            undo: 'undo'
          }
        },
        taskbar: {
          0: '',
          mapping: {
            style: 'style'
          }
        },
        focus_tracker: {
          0: '',
          mapping: {
            focused: 'focused'
          }
        }
      },
      drive: {
        'style/': {
          'theme.css': {
            raw: `
              .theme-widget {
                display: flex;
                flex-direction: column;
                width: 100%;
                height: 100%;
                background: #131315;
              }
              .space{
                height: inherit;
              }
            `
          }
        },
        'flags/': {},
        'commands/': {},
        'icons/': {},
        'scroll/': {},
        'actions/': {},
        'hardcons/': {},
        'files/': {},
        'highlight/': {},
        'active_tab/': {},
        'entries/': {},
        'runtime/': {},
        'mode/': {},
        'keybinds/': {},
        'undo/': {},
        'focused/': {}
      }
    }
  }
}
