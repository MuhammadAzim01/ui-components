const STATE = require('STATE')
const statedb = STATE(__filename)
const { get } = statedb(fallback_module)

const program_container = require('program_container')
const taskbar = require('taskbar')

module.exports = theme_widget

async function theme_widget (opts, protocol) {
  const { id, sdb } = await get(opts.sid)
  const { drive } = sdb

  const on = {
    style: inject,
    focused: handle_focused
  }

  // Inline focus tracking (merged from focus_tracker)
  let last_focused = null
  let mid = 0

  const el = document.createElement('div')
  const shadow = el.attachShadow({ mode: 'closed' })
  shadow.innerHTML = `
  <div class="theme-widget main">
    <div class="program-container-slot"></div>
    <div class="taskbar-slot"></div>
  </div>
  <style>
  </style>
  `

  const style = shadow.querySelector('style')
  const program_container_slot = shadow.querySelector('.program-container-slot')
  const taskbar_slot = shadow.querySelector('.taskbar-slot')

  const subs = await sdb.watch(onbatch)

  let program_container_el = null
  let taskbar_el = null
  const _ = { send_program_container: null, send_taskbar: null }
  if (protocol) {
    _.up = protocol(onmessage_from_root)
  }

  function onmessage_from_root (msg) {
    const action_handlers = {
      update_actions_for_app: root__update_actions_for_app,
      update_quick_actions_for_app: root__forward_taskbar,
      update_steps_wizard_for_app: root__forward_taskbar
    }
    const handler = action_handlers[msg.type] || root__noop
    handler(msg)

    function root__update_actions_for_app (msg) {
      if (_.send_program_container) _.send_program_container(msg)
      else setTimeout(root__retry_send_program_container, 500, msg)
    }

    function root__retry_send_program_container (msg) {
      _.send_program_container && _.send_program_container(msg)
    }

    function root__forward_taskbar (msg) {
      _.send_taskbar && _.send_taskbar(msg)
    }

    function root__noop () {}
  }

  taskbar_el = await taskbar({ ...subs[1], ids: { up: id } }, taskbar_protocol)
  taskbar_slot.replaceWith(taskbar_el)

  program_container_el = await program_container({ ...subs[0], ids: { up: id } }, program_container_protocol)
  program_container_el.classList.add('program-container')
  program_container_slot.replaceWith(program_container_el)

  return el

  async function onbatch (batch) {
    for (const { type, paths } of batch) {
      const data = await Promise.all(paths.map(path => drive.get(path).then(file => file.raw)))
      const func = on[type] || fail
      func(data, type)
    }
  }
  function fail (data, type) { console.warn('invalid message', { cause: { data, type } }) }
  function inject (data) {
    style.replaceChildren((() => {
      const style_el = document.createElement('style')
      style_el.textContent = data[0]
      return style_el
    })())
  }

  // Inline focus tracker: reads persisted focused value to keep last_focused in sync
  function handle_focused (data) {
    const focused = typeof data[0] === 'string' ? JSON.parse(data[0]) : data[0]
    last_focused = focused.value
  }

  // Inline focus tracker: handles ui_focus messages from children
  function handle_ui_focus (msg) {
    if (last_focused !== msg.data.type) {
      const head = [id, _.up ? opts.ids.up : id, mid++]
      const refs = {}
      _.up && _.up({ head, refs, type: 'focused_app_changed', data: msg.data })
    }
    drive.put('focused/current.json', { value: msg.data.type })
  }

  // ---------
  // PROTOCOLS
  // ---------
  function program_container_protocol (send) {
    _.send_program_container = send
    const action_handlers = {
      ui_focus: program_container__forward_ui_focus,
      set_doc_display_handler: program_container__forward_up
    }
    return on
    function on (msg) {
      const handler = action_handlers[msg.type] || program_container__forward_taskbar
      handler(msg)
    }

    function program_container__forward_ui_focus (msg) {
      handle_ui_focus(msg)
    }

    function program_container__forward_up (msg) {
      _.up && _.up(msg)
    }

    function program_container__forward_taskbar (msg) {
      _.send_taskbar && _.send_taskbar(msg)
    }
  }

  function taskbar_protocol (send) {
    _.send_taskbar = send
    const action_handlers = {
      ui_focus: taskbar__forward_ui_focus,
      docs_toggle: taskbar__docs_toggle,
      set_docs_mode: taskbar__forward_up
    }
    return on
    function on (msg) {
      const handler = action_handlers[msg.type] || taskbar__forward_program_container
      handler(msg)
    }

    function taskbar__forward_ui_focus (msg) {
      handle_ui_focus(msg)
    }

    function taskbar__docs_toggle (msg) {
      handle_ui_focus(msg)
      _.send_program_container && _.send_program_container(msg)
    }

    function taskbar__forward_up (msg) {
      _.up && _.up(msg)
    }

    function taskbar__forward_program_container (msg) {
      _.send_program_container && _.send_program_container(msg)
    }
  }
}

function fallback_module () {
  return {
    api: fallback_instance,
    _: {
      program_container: {
        $: ''
      },
      taskbar: {
        $: ''
      }
    },
    drive: {}
  }

  function fallback_instance () {
    return {
      _: {
        program_container: {
          0: '',
          mapping: {
            style: 'style',
            icons: 'icons',
            commands: 'commands',
            scroll: 'scroll',
            actions: 'actions',
            hardcons: 'hardcons',
            files: 'files',
            highlight: 'highlight',
            active_tab: 'active_tab',
            entries: 'entries',
            runtime: 'runtime',
            mode: 'mode',
            flags: 'flags',
            keybinds: 'keybinds',
            undo: 'undo',
            focused: 'focused',
            temp_actions: 'temp_actions',
            temp_quick_actions: 'temp_quick_actions',
            prefs: 'prefs',
            variables: 'variables',
            data: 'data',
            docs: 'docs',
            docs_style: 'docs_style'
          }
        },
        taskbar: {
          0: '',
          mapping: {
            style: 'style',
            icons: 'icons',
            actions: 'actions',
            prefs: 'prefs',
            variables: 'variables',
            data: 'data',
            hardcons: 'hardcons',
            docs: 'docs'
          }
        }
      },
      drive: {
        'style/': {
          'theme.css': {
            raw: `
              .theme-widget {
                display: flex;
                flex-direction: column;
                width: 100%;
                height: 100%;
                background: #131315;
              }
              .program-container {
                height: inherit;
              }
            `
          }
        },
        'flags/': {},
        'commands/': {},
        'icons/': {},
        'scroll/': {},
        'actions/': {},
        'hardcons/': {},
        'files/': {},
        'highlight/': {},
        'active_tab/': {},
        'entries/': {},
        'runtime/': {},
        'mode/': {},
        'keybinds/': {},
        'undo/': {},
        'focused/': {
          'current.json': {
            raw: { value: 'default' }
          }
        },
        'temp_actions/': {},
        'temp_quick_actions/': {},
        'prefs/': {},
        'variables/': {},
        'data/': {},
        'docs_style/': {},
        'docs/': {
          'README.md': {
            $ref: 'README.md'
          }
        }
      }
    }
  }
}
